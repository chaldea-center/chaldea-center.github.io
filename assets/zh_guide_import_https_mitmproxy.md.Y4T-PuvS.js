import{_ as i,c as s,o as a,a5 as l,ae as e}from"./chunks/framework.-i2sbza6.js";const g=JSON.parse('{"title":"mitmproxy 抓包","description":"","frontmatter":{},"headers":[],"relativePath":"zh/guide/import_https/mitmproxy.md","filePath":"zh/guide/import_https/mitmproxy.md","lastUpdated":1708704848000}'),t={name:"zh/guide/import_https/mitmproxy.md"},o=l(`<h1 id="mitmproxy-抓包" tabindex="-1">mitmproxy 抓包 <a class="header-anchor" href="#mitmproxy-抓包" aria-label="Permalink to &quot;mitmproxy 抓包&quot;">​</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>2022.01.04 国服更新 2.36.0 支持 iOS/Android 互登。Android操作麻烦，若可使用iOS设备推荐<a href="./stream">Stream</a>方法。</p></div><p>主要步骤有就设置代理和安装证书两步，mitmproxy和Charles均可适用（除软件自身设置外）。以下以Windows平台+Android模拟器(雷电5模拟器)为例。</p><h2 id="模拟器选择" tabindex="-1">模拟器选择 <a class="header-anchor" href="#模拟器选择" aria-label="Permalink to &quot;模拟器选择&quot;">​</a></h2><p>除蓝叠等少数系统设置严重阉割的模拟器外应均可适用。部分模拟器可能WiFi的代理设置无法生效(若雷电5的Android7版本)，或部分app也会无视代理，故本教程统一使用Drony进行全局代理。</p><p>Android版本选择:</p><ol><li>Android 6: 如Mumu6，支持国服，用户证书即可，无需adb，但日服要求Android 7+故无法安装</li><li>Android 7-11: 需借助adb将证书安装至系统证书</li><li>Android 12: 似乎存在更麻烦的情况，未测试</li></ol><h2 id="所需软件或工具" tabindex="-1">所需软件或工具 <a class="header-anchor" href="#所需软件或工具" aria-label="Permalink to &quot;所需软件或工具&quot;">​</a></h2><p>下载链接: <a href="https://disk.chaldea.center/s/4zfd" target="_blank" rel="noreferrer">https://disk.chaldea.center/s/4zfd</a> 点击打包下载</p><p>下载后解压至(举例)<code>D:\\fgotools</code>文件夹，<strong>建议完整路径不要包含非英文字符和空格</strong>。</p><p>包含以下文件:</p><ul><li>抓包脚本</li><li>mitmproxy安装包 (mitmproxy-windows-installer.exe, 10.2.2版本) <ul><li>若需更新或下载macOS/Linux版本，请访问官网<a href="https://www.mitmproxy.org/" target="_blank" rel="noreferrer">https://www.mitmproxy.org/</a></li><li>mitmproxy有安装包版(安装到系统中)和非安装包版(解压zip直接运行)，其中非安装版在部分电脑上可能显示不兼容，请下载安装包(installer)安装到系统中使用</li></ul></li><li>adb: 存放于<code>fgotools\\platform-tools</code>文件夹 <ul><li>仅在Android版本&gt;=7时需要，若系统已root且已安装Magisk等框架，可搜索JustTrustMe等相应插件用于复制证书即可。<div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>由于adb版本和模拟器版本众多，极有可能不兼容。一般模拟器自带adb工具，大概率储存于模拟器的安装目录(如<code>D:\\LDPlayer9\\adb.exe</code>)，可在其adb.exe所在目录菜单打开cmd或powershell，或在该目录地址栏输入cmd或powershell打开<br><strong>推荐优先使用模拟器自带adb</strong></p></div></li></ul></li><li>Drony 1.3.154 <ul><li>该apk经过测试可用。网上下载的版本五花八门，即使版本号相同也极有可能已遭多次修改无法正常使用。</li></ul></li></ul><h2 id="设置mitmptoxy" tabindex="-1">设置mitmptoxy <a class="header-anchor" href="#设置mitmptoxy" aria-label="Permalink to &quot;设置mitmptoxy&quot;">​</a></h2><p>一般无需修改，仅确认端口用于后续步骤使用。</p><p><code>start.cmd</code>文件内容:</p><div class="language-bat vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bat</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mitmdump.exe -p </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8888</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -s fgoaddon.py</span></span></code></pre></div><p>其中<code>8888</code>即为代理端口。除非出现以下错误说明端口已占用，修改上述数字至其他数字保存后再重试。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>[Errno 10048] HTTP(S) proxy failed to listen on *:8888 with</span></span>
<span class="line"><span>[Errno 10048] error while attempting to bind on address (&#39;::&#39;, 8888, 0, 0):</span></span>
<span class="line"><span>通常每个套接字地址(协议/ 网络地址/端口)只允许使用一次。</span></span>
<span class="line"><span>only one usage of each socket address (protocol/network address/port) is normally permitted</span></span></code></pre></div><h2 id="设置代理" tabindex="-1">设置代理 <a class="header-anchor" href="#设置代理" aria-label="Permalink to &quot;设置代理&quot;">​</a></h2><p><img src="`+e+`" alt="Android Configuration" loading="lazy"></p><figcaption style="text-align:center;">Android配置（无视左侧两张wifi设置）</figcaption><ol><li>获取电脑的<code>IP地址(主机名)</code>，有两种方法: <ol><li>模拟器中打开<code>系统设置-WiFi-设置/信息-IP地址</code>或<code>系统设置-关于平板电脑-状态信息-IP地址</code><ul><li>模拟器地址为172.16.1.15，则电脑的ip位172.16.1.2。其他模拟器同理仅更改最后一位为2</li></ul></li><li>打开cmd或PowerShell，输入<code>ipconfig</code>选择合适的IPv4地址(可能存在多个，请依此尝试)</li></ol></li><li>安装 Drony，只有英文和繁体，根据系统语言显示，参考上图</li><li>打开后显示日志页和设置页，左右滑动切换到设置页</li><li>网络-无线网络-选择连接的 WiFi-网络细节设置 <ul><li>WiFi 名: <code>代理类型/Proxy type</code>选<code>手动/Manual</code></li><li>WiFi 名-手动代理/Manual Proxy: <code>主机名</code>和<code>端口</code>同上一步，<code>代理类型/Proxy type</code>选<code>普通/Plain</code></li><li>WiFi 名-过滤器/Filter: 过滤默认值选择<code>本地代理链全部/Local Proxy Chain All</code></li><li>返回</li></ul></li><li>过滤器-默认值: 选择<code>引导全部/Direct All</code></li><li>左滑回到日志页，点击底部开关，开启后在通知栏可以看到 ⅤΡΝ 连接提示，第一次使用会申请创建 ⅤΡΝ 的权限。在 Charles 中会弹出提示，并允许接收来自此设备的请求。</li></ol><p>后续使用/关闭仅需点击开关即可，无需其他操作。若WiFi变化(如在手机上使用)，需重新设置上述步骤。</p><h2 id="安装证书" tabindex="-1">安装证书 <a class="header-anchor" href="#安装证书" aria-label="Permalink to &quot;安装证书&quot;">​</a></h2><ol><li>确保Drony为开启状态</li><li>浏览器打开<code>http://mitm.it</code>，点击<code>Android - Get-mitmproxy-ca-cert.cer</code>下载并安装 <ul><li>若显示 traffic is not passing through mitmproxy 等英文，请检查“设置代理”步骤。</li><li>需设置PIN、密码、手势等至少一项安全措施</li><li>名字填写mitmproxy(随意)</li><li>用途为<code>VPN和应用</code></li></ul></li><li>可在<code>系统设置-安全-信任的凭据-用户</code>处找到刚安装的证书</li><li>在模拟器设置中开启: <ol><li><strong>ROOT权限</strong></li><li><strong>ADB调试</strong>: 开启本地连接</li><li><strong>磁盘可写入</strong>: 如雷电9中的 磁盘共享-System.vmdk可写入</li></ol></li></ol><div class="info custom-block"><p class="custom-block-title">INFO</p><p>mitmproxy证书默认有效期10年，Charles证书默认有效期1年，过期后需删除重新安装。</p></div><p>Android 7及以上版本系统将不信任用户证书，需要将用户证书移动至系统证书。</p><ul><li>Android 6及以下无需操作，直接调到下一节，Mumu6为Android 6，但已停止更新</li><li>Magisk框架等可安装JustTrustMe等插件实现</li><li>日服安装包要求Android 7+，否则日服安装包直接安装失败</li></ul><ol><li><p>打开PowerShell或CMD（打开adb所在目录platform-tools，窗口菜单里找到<code>在PowerShell中打开</code>，若未找到直接搜索并打开）</p><p>确保命令行窗口显示platform-tools文件夹或模拟器自带adb所在目录:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>D:\\fgotools\\platform-tools\\&gt;</span></span>
<span class="line"><span>D:\\LDPlayer9\\&gt;</span></span></code></pre></div><p>若不是，请执行:</p><div class="language-ps vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ps</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cd D:\\fgotools\\platform</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tools\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cd D:\\LDPlayer9\\</span></span></code></pre></div></li><li><p>输入<code>adb devices</code></p><p>显示</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>List of devices attached</span></span>
<span class="line"><span>127.0.0.1:5557  device</span></span>
<span class="line"><span>emulator-5556   offline</span></span></code></pre></div><p>其中<code>127.0.0.1:5557</code>或<code>emulator-5556</code>为模拟器名称，一般取前者，逐个试即可。若此处只显示一行，则略过且下一步无需指定<code>-s 127.0.0.1:5557</code></p></li><li><p>输入<code>adb -s 127.0.0.1:5557 shell</code></p><p>若显示<code>xxxx:/ #</code>表示成功</p></li><li><p>输入</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw,remount,rw /system</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/misc/user/0/cacerts-added/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  /system/etc/security/cacerts/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ro,remount,ro /system</span></span></code></pre></div><p>在高版本Android系统中可能提示<code>mount: &#39;/system&#39; not in /proc/mounts</code>，则使用</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rw,remount /</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /data/misc/user/0/cacerts-added/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  /system/etc/security/cacerts/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mount</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ro,remount /</span></span></code></pre></div></li><li><p>打开<code>系统设置-安全-信任的凭据-系统</code>标签页可找到mitmproxy证书</p></li><li><p>重启模拟器或手机！</p></li></ol><h2 id="开始抓包" tabindex="-1">开始抓包 <a class="header-anchor" href="#开始抓包" aria-label="Permalink to &quot;开始抓包&quot;">​</a></h2><ol><li>双击<code>start.cmd</code>启动抓包</li><li>打开FGO登录直到出现地球仪或公告页面</li><li>检查目录下生成的<code>toplogin**.json</code>的文件，导入Chaldea即可</li></ol><h2 id="结束及清理" tabindex="-1">结束及清理 <a class="header-anchor" href="#结束及清理" aria-label="Permalink to &quot;结束及清理&quot;">​</a></h2><ol><li>关闭Drony及其他窗口</li><li>若以后不再使用，可在<code>系统设置-安全-信任的凭据</code>中删除mitmproxy证书</li></ol><h2 id="再次抓包" tabindex="-1">再次抓包 <a class="header-anchor" href="#再次抓包" aria-label="Permalink to &quot;再次抓包&quot;">​</a></h2><ol><li>打开Drony，点击开启</li><li>打开<code>start.cmd</code></li><li>开始抓包</li></ol><h2 id="faq" tabindex="-1">FAQ <a class="header-anchor" href="#faq" aria-label="Permalink to &quot;FAQ&quot;">​</a></h2><ul><li><a href="./#常见问题-faq">FAQ</a></li><li>若出现 mitm.it 一直加载打不开，或 FGO 连不上等，可尝试在黑色 cmd 窗口中输入任意字符，有可能 cmd 卡住了</li></ul>`,37),n=[o];function p(d,r,c,h,m,k){return a(),s("div",null,n)}const y=i(t,[["render",p]]);export{g as __pageData,y as default};
